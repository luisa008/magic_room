<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/109/three.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/three@0.140/build/three.js"></script> -->
		<script src="js/three.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/loaders/GLTFLoader.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/controls/OrbitControls.js"></script>
		
		<!-- For Unreal Bloom Effect-->
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/shaders/CopyShader.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/shaders/LuminosityHighPassShader.js"></script>
		<script type="text/js" src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/shaders/ShaderChunk/tonemapping_pars_fragment.glsl.js"></script>
		
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/postprocessing/Pass.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/postprocessing/RenderPass.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/postprocessing/ShaderPass.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/postprocessing/EffectComposer.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.140/examples/js/postprocessing/UnrealBloomPass.js"></script>
	
		<script type="x-shader/x-vertex" id="vertexshader">

			varying vec2 vUv;

			void main() {

				vUv = uv;

				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			}

		</script>

		<script type="x-shader/x-fragment" id="fragmentshader">

			uniform sampler2D baseTexture;
			uniform sampler2D bloomTexture;

			varying vec2 vUv;

			void main() {

				gl_FragColor = ( texture2D( baseTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) );

			}

		</script>

		<script src="index.js"></script>
		<script src="js/postprocess.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/room1.js"></script>
		<script src="js/room2.js"></script>
		<script src="js/control/keyboard.js"></script>
		<script src="js/control/mouse.js"></script>
		<script>
			function animate() {
				room1Animate();
				room2Animate();
			}
			// function render(){
			// 	requestAnimationFrame( render );
			// 	animate();
				
			// 	renderer.clear();
			// 	camera.layers.set(1);
			// 	if(bloomComposer) {
			// 		// console.log("bloom");
			// 		bloomComposer.render();
			// 	}
				
			// 	// // 清除深度缓存
			// 	renderer.clearDepth();
			// 	camera.layers.set(0);

			// 	renderer.render(scene, camera);
			// }
			function render(){
				requestAnimationFrame( render );
				animate();
		
				// 實現區域性輝光
				// 1. 利用 darkenNonBloomed 函式將除輝光物體外的其他物體的材質轉成黑色
				scene.traverse(darkenNonBloomed);
				// 2. 用 bloomComposer 產生輝光
				bloomComposer.render();
				// 3. 將轉成黑色材質的物體還原成初始材質
				scene.traverse(restoreMaterial);
				// 4. 用 finalComposer 作最後渲染
				finalComposer.render();
			}
			render();
		</script>
	</body>
</html>